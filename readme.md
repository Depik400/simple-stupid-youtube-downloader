# youtube_downloader

## Описание проекта

`youtube_downloader` — это HTTP-сервер на Go (Golang), который позволяет скачивать видео с YouTube по ссылке с указанием качества. Сервер использует `yt-dlp` для скачивания, обрабатывает запросы асинхронно через горутины, хранит историю запросов в базе SQLite и автоматически чистит старые файлы и записи через 24 часа. Логирование всех действий ведётся в файл `server.log`.

### Основные возможности
- Принимает GET-запросы на `/download` с параметрами `url` (ссылка на видео) и `quality` (качество, по умолчанию `hd720`).
- Скачивает видео с помощью `yt-dlp`, автоматически склеивая видео и аудио через `ffmpeg`.
- Оптимизация: если видео с таким же URL и качеством уже скачано и файл существует, возвращает его без повторной обработки.
- Статусы обработки запросов: `pending` (обрабатывается), `completed` (успешно завершено), `failed` (ошибка).
- Восстановление незавершённых задач при перезапуске сервера.
- Воркер пул: ограничивает количество одновременных задач скачивания (по умолчанию 5 воркеров).
- Очистка: удаляет файлы и записи в базе старше 24 часов.
- Логирование всех действий в файл `server.log`.

---

## Требования

Для работы проекта нужно установить следующие зависимости:

1. **Go**: Версия 1.21 или выше (для запуска без Docker).
2. **yt-dlp**: Для скачивания видео с YouTube.
   - Установить: `pip install yt-dlp`
3. **ffmpeg**: Для обработки видео (склейка видео и аудио).
   - На Ubuntu: `sudo apt-get install ffmpeg`
   - На Mac: `brew install ffmpeg`
   - На Windows: Скачать с [официального сайта](https://ffmpeg.org/download.html) и добавить в PATH.
4. **Docker**: Если хочешь запускать через Docker.

---

## Установка

### Установка без Docker
1. **Установите зависимости**:
   ```bash
   go get github.com/mattn/go-sqlite3
   pip install yt-dlp
   sudo apt-get install ffmpeg  # или другой способ для вашей ОС
   ```

2. **Склонируйте или создайте проект**:
   Если код не в репозитории, создайте файл `youtube_downloader.go` и вставьте туда код из проекта.

3. **Убедитесь, что `yt-dlp` и `ffmpeg` установлены**:
   Проверьте командами:
   ```bash
   yt-dlp --version
   ffmpeg -version
   ```

### Установка с Docker
1. **Соберите Docker-образ**:
   ```bash
   docker build -t youtube_downloader .
   ```

2. **Запустите контейнер**:
   ```bash
   docker run -d -p 8080:8080 -v $(pwd)/data:/data youtube_downloader
   ```
   - `-p 8080:8080`: Прокидывает порт 8080 для доступа к серверу.
   - `-v $(pwd)/data:/data`: Монтирует локальную директорию `data` для хранения логов, базы и скачанных файлов.

---

## Структура проекта

После запуска проекта создаются следующие файлы (в директории `/data` для Docker или текущей директории без Docker):

- `youtube_downloader.go`: Основной код приложения.
- `server.log`: Лог-файл с записями всех действий сервера.
- `downloads.db`: База данных SQLite с записями о запросах.

### Структура базы данных
Таблица `downloads` в `downloads.db` имеет следующие поля:
- `id` (INTEGER, PRIMARY KEY, AUTOINCREMENT): Уникальный идентификатор запроса.
- `url` (TEXT): Ссылка на видео.
- `quality` (TEXT): Качество видео (например, `hd1080`, `hd720`).
- `file_path` (TEXT): Путь к скачанному файлу (заполняется после успешной обработки).
- `status` (TEXT): Статус обработки (`pending`, `completed`, `failed`).
- `created_at` (TIMESTAMP): Время создания записи.

---

## Использование

### Запуск без Docker
1. Перейдите в директорию с проектом.
2. Запустите сервер:
   ```bash
   go run youtube_downloader.go
   ```
   Сервер запустится на `http://localhost:8080`.

### Запуск с Docker
1. Соберите образ и запустите контейнер (см. инструкции выше).
2. Сервер будет доступен на `http://localhost:8080`.

### Выполнение запросов
Сделайте GET-запрос на endpoint `/download` с параметрами `url` и `quality`.

Пример запроса:
```
http://localhost:8080/download?url=https://www.youtube.com/watch?v=rFejpH_tAHM&quality=hd1080
```

- Параметры:
  - `url` (обязательный): Ссылка на YouTube-видео.
  - `quality` (опциональный): Качество видео (например, `hd1080`, `hd720`). По умолчанию `hd720`.

Пример с `curl`:
```bash
curl -O "http://localhost:8080/download?url=https://www.youtube.com/watch?v=rFejpH_tAHM&quality=hd1080"
```

Браузер или `curl` скачает файл с именем вида `downloaded_123456.mp4`.

---

## Документация по коду

### Основные компоненты
1. **HTTP-сервер**:
   - Хендлер `/download` (`downloadHandler`): Обрабатывает GET-запросы, проверяет базу на наличие готового файла, если его нет — создаёт новую задачу.
   - Использует воркер пул (`workerPool`) для ограничения числа одновременно выполняемых задач скачивания.


	apiServer = os.Getenv("API_SERVER")
	if apiServer == "" {
		apiServer = "http://localhost:4040" // Значение по умолчанию
	}
	telegramToken = os.Getenv("TELEGRAM_TOKEN")
	if telegramToken == "" {
		telegramToken = "7507708709:AAHVOuavXE5gEg50V2K-A1A9W0nOIGFjt0s"
	}

2. **Воркер пул**:
   - Канал `workerPool` с фиксированным числом слотов (`maxWorkers = 5`).
   - Каждый запрос занимает слот перед началом обработки и освобождает его после.

3. **Скачивание видео**:
   - Функция `downloadAndProcessVideo`: Вызывает `yt-dlp` для скачивания видео с указанным качеством. Автоматически склеивает видео и аудио через `ffmpeg`.

4. **База данных SQLite**:
   - Таблица `downloads` хранит информацию о запросах.
   - При получении запроса создаётся запись со статусом `pending`.
   - После обработки статус обновляется на `completed` или `failed`.

5. **Очистка старых файлов и записей**:
   - Горутина `cleanupWorker` каждые час проверяет файлы и записи в базе, удаляет те, что старше 24 часов.
   - Использует `sync.Map` (`fileRecords`) для хранения информации о файлах.

6. **Восстановление незавершённых задач**:
   - Функция `recoverPendingTasks`: При старте сервера проверяет записи со статусом `pending` и перезапускает их.

7. **Логирование**:
   - Все действия (запуск сервера, обработка запросов, ошибки) логируются в файл `server.log` с помощью `log.Logger`.

### Основные функции
- `main()`: Инициализация сервера, базы данных, воркер пула, запуск горутин для очистки и восстановления.
- `downloadHandler(w, r)`: Хендлер для обработки GET-запросов на `/download`.
- `processTask(task)`: Обработка задачи скачивания (включая обновление статуса в базе).
- `downloadAndProcessVideo(url, quality, outputFile)`: Логика скачивания через `yt-dlp`.
- `cleanupWorker()`: Очистка старых файлов и записей в базе.
- `recoverPendingTasks()`: Восстановление незавершённых задач при старте.

---

## Примеры логов
Пример записи в `server.log`:
```
INFO: 2023/10/01 12:00:00 youtube_downloader.go:123: Сервер запущен на http://localhost:8080
INFO: 2023/10/01 12:00:05 youtube_downloader.go:234: Начинаем обработку: url=https://www.youtube.com/watch?v=rFejpH_tAHM, quality=hd1080, output=downloaded_123456
INFO: 2023/10/01 12:00:15 youtube_downloader.go:456: Обработка завершена: downloaded_123456.mp4
```

---

## Возможные улучшения
1. **Прогресс скачивания**: Добавить WebSocket или заголовок `Transfer-Encoding: chunked` для отображения прогресса клиенту.
2. **Аутентификация**: Добавить API-ключи или HTTP-аутентификацию для ограничения доступа.
3. **Хранилище**: Использовать облачное хранилище вместо локальных файлов.
4. **Очереди с приоритетами**: Добавить приоритеты для задач скачивания.
5. **Мониторинг**: Добавить endpoint для проверки статуса задач (например, `/status?id=123`).

---

## Ограничения
- **Юридическая сторона**: Скачивание видео с YouTube может нарушать их условия использования. Используйте только для личных нужд и с разрешения правообладателей.
- **Ограничения YouTube**: Видео с возрастными ограничениями или DRM-защитой могут быть недоступны для скачивания.
- **Зависимость от `yt-dlp` и `ffmpeg`**: Если они не установлены или недоступны, скачивание не будет работать.
